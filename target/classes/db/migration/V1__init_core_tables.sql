-- Migration: Initialize core tables required by later migrations
-- Version: V1
-- Description:
--   Creates all core tables with full schema so that subsequent migrations
--   (V2, V3, V4) can add indexes and additional columns without errors.
--   This script uses IF NOT EXISTS for safe re-runs.

-- =====================================================
-- 1. EGITIM TABLE (education/training)
--    Required for odeme.egitim_id FK
-- =====================================================
CREATE TABLE IF NOT EXISTS egitim (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad VARCHAR(255) NOT NULL,
    aciklama CLOB,
    baslangic_tarihi DATE,
    bitis_tarihi DATE,
    durum VARCHAR(50),
    konum VARCHAR(255),
    katilimci_sayisi INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_egitim_ad ON egitim(ad);
CREATE INDEX IF NOT EXISTS idx_egitim_durum ON egitim(durum);

-- =====================================================
-- 2. SORUMLU TABLE (responsible persons)
--    Required for odeme.sorumlu_id FK and V4 ALTER
-- =====================================================
CREATE TABLE IF NOT EXISTS sorumlu (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad VARCHAR(100) NOT NULL,
    soyad VARCHAR(100) NOT NULL,
    email VARCHAR(200),
    telefon VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_sorumlu_ad ON sorumlu(ad);
CREATE INDEX IF NOT EXISTS idx_sorumlu_soyad ON sorumlu(soyad);
CREATE INDEX IF NOT EXISTS idx_sorumlu_email ON sorumlu(email);

-- =====================================================
-- 3. ODEME TABLE (payments) - FULL SCHEMA
--    Required for V2 indexes and V3 timestamps
-- =====================================================
CREATE TABLE IF NOT EXISTS odeme (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    birim_ucret DECIMAL(10, 2),
    toplam_ucret DECIMAL(10, 2),
    odeme_kaynagi VARCHAR(200),
    durum VARCHAR(50),
    operasyon VARCHAR(100),
    is_deleted BOOLEAN DEFAULT FALSE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP,
    egitim_id BIGINT,
    sorumlu_id BIGINT,
    CONSTRAINT fk_odeme_egitim FOREIGN KEY (egitim_id) REFERENCES egitim(id),
    CONSTRAINT fk_odeme_sorumlu FOREIGN KEY (sorumlu_id) REFERENCES sorumlu(id)
);

-- Note: Indexes will be created by V2 migration

-- =====================================================
-- 4. EGITMEN TABLE (trainers)
-- =====================================================
CREATE TABLE IF NOT EXISTS egitmen (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad VARCHAR(100) NOT NULL,
    soyad VARCHAR(100) NOT NULL,
    email VARCHAR(200),
    telefon VARCHAR(20),
    il VARCHAR(50),
    calisma_yeri VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_egitmen_ad ON egitmen(ad);
CREATE INDEX IF NOT EXISTS idx_egitmen_soyad ON egitmen(soyad);

-- =====================================================
-- 5. KATEGORI TABLE (categories)
-- =====================================================
CREATE TABLE IF NOT EXISTS kategori (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad VARCHAR(200) NOT NULL,
    aciklama VARCHAR(500),
    ust_kategori_id BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP,
    CONSTRAINT fk_kategori_ust FOREIGN KEY (ust_kategori_id) REFERENCES kategori(id)
);

CREATE INDEX IF NOT EXISTS idx_kategori_ad ON kategori(ad);

-- =====================================================
-- 6. PAYDAS TABLE (stakeholders)
-- =====================================================
CREATE TABLE IF NOT EXISTS paydas (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad VARCHAR(200) NOT NULL,
    tip VARCHAR(100),
    aciklama VARCHAR(500),
    iletisim VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_paydas_ad ON paydas(ad);

-- =====================================================
-- 7. PROJE TABLE (projects)
-- =====================================================
CREATE TABLE IF NOT EXISTS proje (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad VARCHAR(255) NOT NULL,
    aciklama CLOB,
    baslangic_tarihi DATE,
    bitis_tarihi DATE,
    durum VARCHAR(50),
    butce DECIMAL(15, 2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_proje_ad ON proje(ad);
CREATE INDEX IF NOT EXISTS idx_proje_durum ON proje(durum);

-- =====================================================
-- 8. FAALIYET TABLE (activities)
-- =====================================================
CREATE TABLE IF NOT EXISTS faaliyet (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad VARCHAR(255) NOT NULL,
    aciklama CLOB,
    tarih DATE,
    durum VARCHAR(50),
    tip VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_faaliyet_ad ON faaliyet(ad);
CREATE INDEX IF NOT EXISTS idx_faaliyet_tarih ON faaliyet(tarih);

-- =====================================================
-- 9. SORUMLU_UNVANLAR TABLE (responsible titles - ElementCollection)
-- =====================================================
CREATE TABLE IF NOT EXISTS sorumlu_unvanlar (
    sorumlu_id BIGINT NOT NULL,
    unvan VARCHAR(100),
    CONSTRAINT fk_sorumlu_unvanlar_sorumlu FOREIGN KEY (sorumlu_id) REFERENCES sorumlu(id)
);

CREATE INDEX IF NOT EXISTS idx_sorumlu_unvanlar_sorumlu_id ON sorumlu_unvanlar(sorumlu_id);

-- =====================================================
-- MANY-TO-MANY JOIN TABLES
-- =====================================================

-- Egitim <-> Egitmen
CREATE TABLE IF NOT EXISTS egitim_egitmenler (
    egitim_id BIGINT NOT NULL,
    egitmen_id BIGINT NOT NULL,
    PRIMARY KEY (egitim_id, egitmen_id),
    CONSTRAINT fk_ee_egitim FOREIGN KEY (egitim_id) REFERENCES egitim(id),
    CONSTRAINT fk_ee_egitmen FOREIGN KEY (egitmen_id) REFERENCES egitmen(id)
);

-- Egitim <-> Sorumlu
CREATE TABLE IF NOT EXISTS egitim_sorumlular (
    egitim_id BIGINT NOT NULL,
    sorumlu_id BIGINT NOT NULL,
    PRIMARY KEY (egitim_id, sorumlu_id),
    CONSTRAINT fk_es_egitim FOREIGN KEY (egitim_id) REFERENCES egitim(id),
    CONSTRAINT fk_es_sorumlu FOREIGN KEY (sorumlu_id) REFERENCES sorumlu(id)
);

-- Egitim <-> Kategori
CREATE TABLE IF NOT EXISTS egitim_kategoriler (
    egitim_id BIGINT NOT NULL,
    kategori_id BIGINT NOT NULL,
    PRIMARY KEY (egitim_id, kategori_id),
    CONSTRAINT fk_ek_egitim FOREIGN KEY (egitim_id) REFERENCES egitim(id),
    CONSTRAINT fk_ek_kategori FOREIGN KEY (kategori_id) REFERENCES kategori(id)
);

-- Faaliyet <-> Sorumlu
CREATE TABLE IF NOT EXISTS faaliyet_sorumlular (
    faaliyet_id BIGINT NOT NULL,
    sorumlu_id BIGINT NOT NULL,
    PRIMARY KEY (faaliyet_id, sorumlu_id),
    CONSTRAINT fk_fs_faaliyet FOREIGN KEY (faaliyet_id) REFERENCES faaliyet(id),
    CONSTRAINT fk_fs_sorumlu FOREIGN KEY (sorumlu_id) REFERENCES sorumlu(id)
);

-- Paydas <-> Sorumlu
CREATE TABLE IF NOT EXISTS paydas_sorumlular (
    paydas_id BIGINT NOT NULL,
    sorumlu_id BIGINT NOT NULL,
    PRIMARY KEY (paydas_id, sorumlu_id),
    CONSTRAINT fk_ps_paydas FOREIGN KEY (paydas_id) REFERENCES paydas(id),
    CONSTRAINT fk_ps_sorumlu FOREIGN KEY (sorumlu_id) REFERENCES sorumlu(id)
);

-- Egitim -> Proje (optional FK)
ALTER TABLE egitim ADD COLUMN IF NOT EXISTS proje_id BIGINT;
-- Note: FK constraint will be handled by Hibernate since proje table exists

